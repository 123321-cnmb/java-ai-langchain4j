<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Êô∫ËÉΩÂåªÁñó AI - ÂÖ®ÂäüËÉΩËØ≠Èü≥Áâà</title>
    <style>
        :root { --sidebar-bg: #f8f9fa; --active-item: #e8f0fe; --primary-blue: #1a73e8; }
        body { margin: 0; font-family: 'Segoe UI', system-ui; display: flex; height: 100vh; background: #fff; overflow: hidden; }
        
        /* --- ‰æßËæπÊ†è --- */
        #sidebar { width: 280px; background: var(--sidebar-bg); border-right: 1px solid #dadce0; padding: 16px; display: flex; flex-direction: column; transition: width 0.3s; position: relative; flex-shrink: 0; }
        #sidebar.collapsed { width: 68px; padding: 16px 8px; }
        #sidebar.collapsed .btn-text, #sidebar.collapsed .history-text, #sidebar.collapsed .item-actions { display: none; }
        
        .sidebar-header { display: flex; align-items: center; margin-bottom: 20px; }
        .menu-toggle { background: none; border: none; cursor: pointer; font-size: 20px; color: #5f6368; }
        .btn-new { border: 1px solid #dadce0; background: #fff; padding: 10px; border-radius: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        #history-list { flex: 1; overflow-y: auto; margin-top: 10px; }
        .history-item { position: relative; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; margin-bottom: 4px; }
        .history-item:hover { background: #ebeeef; }
        .history-item.active { background: var(--active-item); color: var(--primary-blue); font-weight: 600; }
        .history-text { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-left: 5px; font-size: 14px; }
        
        .item-actions { position: absolute; right: 5px; display: none; gap: 4px; background: inherit; }
        .history-item:hover .item-actions { display: flex; }
        .op-btn { border: none; background: none; cursor: pointer; padding: 2px; color: #5f6368; font-size: 14px; }
        .op-btn:hover { color: var(--primary-blue); }

        /* --- ‰∏ªËÅäÂ§©Âå∫ --- */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; }
        #chat-window { flex: 1; overflow-y: auto; padding: 40px 10% 120px 10%; scroll-behavior: smooth; display: flex; flex-direction: column; }
        
        .msg-row { display: flex; margin-bottom: 25px; align-items: flex-start; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .avatar { width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; }
        .user-avatar { background: #1a73e8; }
        .ai-avatar { background: #1ea362; }
        .content-wrapper { max-width: 70%; margin: 0 12px; display: flex; flex-direction: column; }
        .content { padding: 12px 16px; border-radius: 12px; font-size: 15px; line-height: 1.6; white-space: pre-wrap; background: #f1f3f4; color: #3c4043; }
        
        .msg-row.right-mode.user { flex-direction: row-reverse; }
        .msg-row.right-mode.user .content { background: var(--primary-blue); color: white; border-radius: 12px 0 12px 12px; }
        .speaker-btn { background: none; border: none; cursor: pointer; color: var(--primary-blue); font-size: 12px; margin-top: 5px; align-self: flex-start; }
        .msg-row.right-mode.user .speaker-btn { align-self: flex-end; }

        /* --- ÁõëÊéßÊù° --- */
        .voice-monitor { width: 100%; height: 4px; background: #eee; position: absolute; top: 0; display: none; z-index: 10; }
        .voice-bar { height: 100%; width: 0%; background: #34a853; transition: width 0.1s; }

        /* --- ËæìÂÖ•Âå∫ --- */
        #input-area { padding: 20px 10% 40px 10%; background: #fff; }
        .input-box { border: 1px solid #dadce0; border-radius: 28px; display: flex; padding: 6px 16px; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.3s; }
        .input-box.ai-speaking { border-color: #34a853; background-color: #f0fff4; box-shadow: 0 0 10px rgba(52, 168, 83, 0.2); }
        input { flex: 1; border: none; outline: none; padding: 10px; font-size: 16px; background: transparent; }
        .icon-btn { background: none; border: none; cursor: pointer; padding: 8px; font-size: 20px; color: #5f6368; border-radius: 50%; display: flex; align-items: center; margin-left: 5px; }
        .icon-btn.recording { color: #d93025; background: #fce8e6; }
        .icon-btn.calling { color: #1ea362; background: #e6f4ea; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .layout-toggle { background: #f1f3f4; border: none; padding: 8px 12px; border-radius: 18px; cursor: pointer; margin-right: 10px; font-size: 12px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header"><button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button></div>
    <div class="btn-new" onclick="startNewChat()"><span class="btn-text">+ Êñ∞ÂØπËØù</span></div>
    <div id="history-list"></div>
</div>

<div id="main">
    <div class="voice-monitor" id="voiceMonitor"><div class="voice-bar" id="voiceBar"></div></div>
    <div id="chat-window"></div>
    <div id="input-area">
        <div class="input-box" id="inputBox">
            <button class="layout-toggle" id="layoutBtn" onclick="toggleLayout()">‰∏ÄÂ∑¶‰∏ÄÂè≥</button>
            <button class="icon-btn" id="micBtn" title="ËØ≠Èü≥ËΩ¨ÊñáÂ≠ó" onclick="toggleVoiceInput()">üé§</button>
            <button class="icon-btn" id="callBtn" title="ÈÄöËØùÊ®°Âºè" onclick="toggleCallMode()">üìû</button>
            <input type="text" id="userInput" placeholder="ÈóÆÈóÆÂ∞èÊô∫..." autocomplete="off">
            <button id="sendBtn" onclick="sendMessage()" style="background:none;border:none;color:var(--primary-blue);font-weight:600;cursor:pointer;padding:0 10px;">ÂèëÈÄÅ</button>
        </div>
    </div>
</div>

<script>
    let currentMemoryId = null;
    let isRightLayout = true;
    let isRecording = false;
    let isCalling = false;
    
    let persistentStream = null; 
    let ws = null;
    let audioCtx = null;
    let scriptProcessor = null;
    let source = null;
    let analyser = null;

    // ÈÄöËØùÊ®°ÂºèÁâπÊúâÂèòÈáè
    let audioQueue = [];
    let isPlaying = false;
    let currentAudio = null;

    const API_BASE = "http://localhost:8080/xiaozhi";
    const WS_ASR = "ws://localhost:8080/voice-asr";
    const WS_CALL = "ws://localhost:8080/voice-call";

    window.onload = () => {
        document.getElementById('userInput').addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage(); });
        refreshHistoryUI();
        startNewChat();
    };

    async function getMediaStream() {
        if (!persistentStream || !persistentStream.active) {
            persistentStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        }
        return persistentStream;
    }

    // --- ËØ≠Èü≥ËΩ¨ÊñáÂ≠óÊ®°Âºè ---
    async function toggleVoiceInput() {
        if (isCalling) stopCallFlow(); 
        if (!isRecording) {
            await getMediaStream();
            startASRFlow();
        } else {
            stopASRFlow();
            setTimeout(() => { if(document.getElementById('userInput').value) sendMessage(); }, 400);
        }
    }

    // --- ÊâìÁîµËØùÊ®°Âºè (Êñ∞ÁâàÈÄªËæë) ---
    async function toggleCallMode() {
        if (isRecording) stopASRFlow();
        if (!isCalling) {
            await getMediaStream();
            startCallFlow();
        } else {
            stopCallFlow();
        }
    }

    async function startASRFlow() {
        ws = new WebSocket(WS_ASR);
        ws.onmessage = (e) => {
            if(e.data) {
                const input = document.getElementById('userInput');
                input.value = e.data;
                input.style.color = "#1a73e8";
            }
        };
        initAudioNodes(WS_ASR);
        isRecording = true;
        document.getElementById('micBtn').classList.add('recording');
        document.getElementById('voiceMonitor').style.display = 'block';
    }

    function stopASRFlow() {
        isRecording = false;
        document.getElementById('micBtn').classList.remove('recording');
        document.getElementById('voiceMonitor').style.display = 'none';
        document.getElementById('userInput').style.color = "#000";
        cleanupAudio();
    }

    // --- ÈÄöËØùÊ®°ÂºèÊ†∏ÂøÉÈÄªËæë ---
    async function startCallFlow() {
        // 1. ÈÄöËøá POST Ëß¶ÂèëÊè°Êâã (Á¨¶ÂêàÁî®Êà∑ÊúÄÊñ∞ÈúÄÊ±Ç)
        try {
            const res = await fetch(`${API_BASE}/start-call`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ memoryId: currentMemoryId })
            });
            if (!res.ok) throw new Error("Êó†Ê≥ïÂàùÂßãÂåñÈÄöËØù");
        } catch (e) { console.warn("POSTÊè°ÊâãÂ§±Ë¥•ÔºåÂ∞ùËØïÁõ¥Êé•ËøûÊé•WS"); }

        ws = new WebSocket(WS_CALL);
        ws.binaryType = "arraybuffer"; // Êé•Êî∂ MP3 ‰∫åËøõÂà∂Â∏ß
        
// Âú® Customer.html ÁöÑ ws.onmessage ‰∏≠‰øÆÊîπ
ws.onmessage = async (e) => {
    if (e.data instanceof ArrayBuffer) {
        // Êî∂Âà∞ÁöÑÊòØ‰∏ÄÊï¥ÊÆµÂÆåÊï¥ÁöÑÈü≥È¢ëÊñá‰ª∂
        const blob = new Blob([e.data], { type: 'audio/mpeg' });
        const url = URL.createObjectURL(blob);
        
        // Â¶ÇÊûú‰πãÂâçËøòÊúâÂú®Êí≠ÊîæÁöÑÂ£∞Èü≥ÔºåÂÖàÂÖ≥ÊéâÔºàÈò≤Ê≠¢ÈáçÂè†Ôºâ
        if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
        }

        currentAudio = new Audio(url);
        currentAudio.onended = () => URL.revokeObjectURL(url);
        await currentAudio.play(); // Ê≠§Êó∂Êí≠ÊîæÂ∞ÜÈùûÂ∏∏‰∏ùÊªëÔºåÁªùÊó†Êñ≠Áª≠
        
    } else if (typeof e.data === 'string') {
        // Â§ÑÁêÜÊñáÂ≠óÁä∂ÊÄÅ... (‰øùÊåÅÂéüÊúâ USER_INTERIM, STATE Á≠âÂà§Êñ≠)
        if (e.data.startsWith("STATE:AI_WAIT_3S")) {
            document.getElementById('userInput').placeholder = "Â∞èÊô∫ÊÄùËÄÉ‰∏≠‚Ä¶‚Ä¶";
        }
    }
};

        initAudioNodes(WS_CALL);
        isCalling = true;
        document.getElementById('callBtn').classList.add('calling');
        document.getElementById('voiceMonitor').style.display = 'block';
        document.getElementById('userInput').placeholder = "ÈÄöËØù‰∏≠ÔºåËØ∑ËØ¥ËØù...";
    }

function handleCallState(state) {
    const input = document.getElementById('userInput');
    const box = document.getElementById('inputBox');
    if (state === "AI_THINKING") {
        input.placeholder = "Â∞èÊô∫Ê≠£Âú®ÊÄùËÄÉ...";
        box.style.backgroundColor = "#fff9db"; // ÊÄùËÄÉÊó∂Áî®ÈªÑËâ≤ÊèêÁ§∫
    } else if (state === "AI_SPEAKING") {
        input.placeholder = "Â∞èÊô∫Ê≠£Âú®Êí≠Êä•ÂõûÁ≠î...";
        box.style.backgroundColor = "#e8f0fe"; // Êí≠Êä•Êó∂Áî®ËìùËâ≤ÊèêÁ§∫
    } else if (state === "AI_SILENT") {
        input.placeholder = "ÈÄöËØù‰∏≠ÔºåËØ∑Áõ¥Êé•ËØ¥ËØù...";
        box.style.backgroundColor = "#fff5f5";
        input.value = ""; 
    }
}

// ‰øÆÊîπÊí≠ÊîæÂáΩÊï∞ÔºåÁ°Æ‰øùÈü≥È¢ëÁâáÊñ≠‰πãÈó¥‰∏ç‰∫ßÁîüÊñ∞ÁöÑ Audio ÂØπË±°Á´û‰∫â
async function playNextChunk() {
    if (audioQueue.length === 0 || !isCalling) {
        isPlaying = false;
        return;
    }
    isPlaying = true;
    const chunk = audioQueue.shift();
    const blob = new Blob([chunk], { type: 'audio/mpeg' });
    const url = URL.createObjectURL(blob);
    
    const audio = new Audio(url);
    currentAudio = audio;

    // ÂÖ≥ÈîÆÔºöÂú®ÂΩìÂâçÁâáÊÆµÂø´ÁªìÊùüÂâçÔºåÈ¢ÑÂä†ËΩΩÊàñÁõ¥Êé•Ë°îÊé•
    audio.onended = () => {
        URL.revokeObjectURL(url);
        // Á´ãÂç≥Ê£ÄÊü•ÈòüÂàóÔºåÊó†ÁºùË°îÊé•
        if (audioQueue.length > 0) {
            playNextChunk();
        } else {
            isPlaying = false;
        }
    };

    try {
        await audio.play();
    } catch (e) {
        console.error("Êí≠ÊîæÂ§±Ë¥•", e);
        playNextChunk();
    }
}

    function stopCallFlow() {
        isCalling = false;
        isPlaying = false;
        audioQueue = [];
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        
        document.getElementById('callBtn').classList.remove('calling');
        document.getElementById('voiceMonitor').style.display = 'none';
        document.getElementById('inputBox').classList.remove('ai-speaking');
        document.getElementById('userInput').placeholder = "ÈóÆÈóÆÂ∞èÊô∫...";
        cleanupAudio();
    }

    function initAudioNodes(targetWsUrl) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
        analyser = audioCtx.createAnalyser();
        source = audioCtx.createMediaStreamSource(persistentStream);
        scriptProcessor = audioCtx.createScriptProcessor(2048, 1, 1);
        source.connect(analyser);
        analyser.connect(scriptProcessor);
        scriptProcessor.connect(audioCtx.destination);
        scriptProcessor.onaudioprocess = (e) => {
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            const avg = data.reduce((a, b) => a + b) / data.length;
            document.getElementById('voiceBar').style.width = Math.min(100, avg * 3) + "%";
            const inputData = e.inputBuffer.getChannelData(0);
            const pcmData = float32ToInt16(inputData);
            if (ws && ws.readyState === WebSocket.OPEN) ws.send(pcmData);
        };
    }

    function cleanupAudio() {
        if (ws) { ws.close(); ws = null; }
        if (scriptProcessor) { scriptProcessor.disconnect(); scriptProcessor = null; }
        if (source) { source.disconnect(); source = null; }
        if (audioCtx) { audioCtx.close(); audioCtx = null; }
    }

    function float32ToInt16(buffer) {
        let l = buffer.length;
        let buf = new Int16Array(l);
        while (l--) {
            let s = Math.max(-1, Math.min(1, buffer[l]));
            buf[l] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
        return buf.buffer;
    }

    // --- ÂéüÊúâÂ∏∏ËßÑÂäüËÉΩ ---
    async function playTTS(text) {
        if (!text) return;
        try {
            const res = await fetch(`${API_BASE}/tts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            await audio.play();
            audio.onended = () => URL.revokeObjectURL(url);
        } catch (e) { console.error("TTSÊí≠ÊîæÂºÇÂ∏∏"); }
    }

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text) return;
        saveToLocal(text);
        if(document.getElementById('chat-window').innerText.includes('‰Ω†Â•ΩÔºåÊàëÊòØÂ∞èÊô∫')) {
            document.getElementById('chat-window').innerHTML = '';
        }
        appendMsgUI('user', text);
        input.value = '';
        const aiDiv = appendMsgUI('ai', '...');
        aiDiv.innerText = '';
        try {
            const res = await fetch(`${API_BASE}/chat`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ memoryId: currentMemoryId, message: text })
            });
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                aiDiv.innerText += decoder.decode(value);
                document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
            }
        } catch (e) { aiDiv.innerText = "ÊúçÂä°‰∏çÂèØÁî®"; }
    }

    function appendMsgUI(role, text) {
        const win = document.getElementById('chat-window');
        const row = document.createElement('div');
        row.className = `msg-row ${role} ${isRightLayout ? 'right-mode' : 'left-mode'}`;
        row.innerHTML = `
            <div class="avatar ${role}-avatar"></div>
            <div class="content-wrapper">
                <div class="content">${text}</div>
                ${role === 'ai' ? `<button class="speaker-btn" onclick="playTTS(this.previousElementSibling.innerText)">üì¢ Êí≠Êä•</button>` : ''}
            </div>
        `;
        win.appendChild(row);
        win.scrollTop = win.scrollHeight;
        return row.querySelector('.content');
    }

    function startNewChat() {
        currentMemoryId = Date.now();
        document.getElementById('chat-window').innerHTML = '<div style="text-align:center;color:#999;margin-top:100px;"><h2>‰Ω†Â•ΩÔºåÊàëÊòØÂ∞èÊô∫</h2><p>ÁÇπÂáª‰∏ãÊñπÈ∫¶ÂÖãÈ£éÂºÄÂêØËØ≠Èü≥‰∫§‰∫í</p></div>';
        refreshHistoryUI();
    }

    async function loadSession(id) {
        currentMemoryId = parseInt(id);
        refreshHistoryUI();
        const win = document.getElementById('chat-window');
        win.innerHTML = '<div style="text-align:center;color:#999;">Ê≠£Âú®ËΩΩÂÖ•ÂéÜÂè≤...</div>';
        try {
            const res = await fetch(`${API_BASE}/history`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ memoryId: currentMemoryId })
            });
            const msgs = await res.json();
            win.innerHTML = '';
            if (Array.isArray(msgs)) msgs.forEach(m => appendMsgUI(m.role, m.content));
        } catch (e) { win.innerHTML = 'ËΩΩÂÖ•Â§±Ë¥•'; }
    }

    function refreshHistoryUI() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        const h = JSON.parse(localStorage.getItem('xz_final_v2') || '[]');
        h.forEach(x => {
            const div = document.createElement('div');
            div.className = `history-item ${x.id == currentMemoryId ? 'active' : ''}`;
            div.onclick = () => loadSession(x.id);
            div.innerHTML = `
                <span class="history-text">üí¨ ${x.title}</span>
                <div class="item-actions">
                    <button class="op-btn" onclick="renameSession(${x.id},'${x.title}',event)">‚úé</button>
                    <button class="op-btn" onclick="deleteSession(${x.id},event)">üóë</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function renameSession(id, old, e) {
        e.stopPropagation();
        const n = prompt("ÈáçÂëΩÂêçÔºö", old);
        if (n) {
            let h = JSON.parse(localStorage.getItem('xz_final_v2') || '[]');
            const i = h.findIndex(x => x.id == id);
            if(i > -1) { h[i].title = n; localStorage.setItem('xz_final_v2', JSON.stringify(h)); refreshHistoryUI(); }
        }
    }

    async function deleteSession(id, e) {
        e.stopPropagation();
        if(!confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊÆµÂØπËØùÂêóÔºü")) return;
        try {
            await fetch(`${API_BASE}/delete-history`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ memoryId: id })
            });
            let h = JSON.parse(localStorage.getItem('xz_final_v2') || '[]');
            h = h.filter(x => x.id != id);
            localStorage.setItem('xz_final_v2', JSON.stringify(h));
            currentMemoryId == id ? startNewChat() : refreshHistoryUI();
        } catch (e) { alert("Âà†Èô§Â§±Ë¥•"); }
    }

    function saveToLocal(t) {
        let h = JSON.parse(localStorage.getItem('xz_final_v2') || '[]');
        if(!h.find(x => x.id == currentMemoryId)) {
            h.unshift({ id: currentMemoryId, title: t.substring(0,10) + '...' });
            localStorage.setItem('xz_final_v2', JSON.stringify(h));
            refreshHistoryUI();
        }
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
    function toggleLayout() {
        isRightLayout = !isRightLayout;
        document.getElementById('layoutBtn').innerText = isRightLayout ? "‰∏ÄÂ∑¶‰∏ÄÂè≥" : "ÂÖ®Èù†Â∑¶‰æß";
        document.querySelectorAll('.msg-row').forEach(r => {
            r.classList.toggle('right-mode', isRightLayout);
            r.classList.toggle('left-mode', !isRightLayout);
        });
    }
</script>
</body>
</html>